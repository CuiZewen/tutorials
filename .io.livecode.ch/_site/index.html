{% extends "base_livecode.html" %}

{% block title %}Generative Programming with LMS{% endblock %}

{% block content %}
<script>
function livecode_html_extra(id) {
  return "<div id=editor-boxit-"+id+"><textarea name=boxit-"+id+" id=boxit-"+id+"></textarea></div>"
}
function livecode_process_data(id, data) {
  var tex = /<code>([\s\S]*?)<\/code>/g;
  var m;
  var a = [];
  while ((m = tex.exec(data)) !== null) {
    a.push(m[1]);
  }
  if (a.length==0) return data;
  $('#boxit-'+id).html(a.join('\n'));
  return data.replace(tex, "");
}
</script>

<div class="live norun" id="lib_a">
val A = scala.Array
val a =
   A(A(1, 1, 1, 1, 1), // dense
     A(0, 0, 0, 0, 0), // null
     A(0, 0, 1, 0, 0), // sparse
     A(0, 0, 0, 0, 0),
     A(0, 0, 1, 0, 1))
</div>

<div class="live" id="hmm1c" data-lib="lib_a">
new DslDriver[Array[Int],Array[Int]] {
  def snippet(v: Rep[Array[Int]]) = {

    def matrix_vector_prod(a0: Array[Array[Int]], v: Rep[Array[Int]]) = {
      val n = a0.length
      val a = staticData(a0)
      val v1 = NewArray[Int](n)

      for (i <- (0 until n):Range) {
        val sparse = a0(i).count(_ != 0) < 3
        if (sparse) {
          for (j <- (0 until n):Range) {
            v1(i) = v1(i) + a(i).apply(j) * v(j)
          }
         } else {
          for (j <- (0 until n):Rep[Range]) {
            v1(i) = v1(i) + a(i).apply(j) * v(j)
          }
        }
      }
      v1
    }

    val v1 = matrix_vector_prod(a, v)
    v1
  }
}
</div>

{% endblock %}
